

{% extends 'base.html' %}

{% block css %}
<link rel="stylesheet" type='text/css' href="{{STATIC_URL}}css/jobs.css"/>
{% endblock %}

{% block scripts %}
{% endblock %}

{% block content %}
<span class='hshrink'>
<h2>Objects</h2>
<ul id='stateful_objects'>
</ul>
</span>

<span class='hshrink'>
<h2>Jobs</h2>
<ul class='ui-style-default' id='jobs'>
</ul>
</span>

<script type='text/javascript'>
    stateful_object_markup = function(container, stateful_object) {
        container.find('.name').html(stateful_object['__str__']);

        var new_state = stateful_object['state'];
        var old_state = container.find('.state').html()
        container.find('.state').html(new_state)
        if (new_state != old_state && old_state != "") {
            container.find('.state').effect('pulsate');
        }

        actions_list = container.find('.actions')
        valid_urls = []
        stateful_object['actions'].forEach(function(action) {
            if(actions_list.children('a[href="' + action['url'] + '"]').length == 0) {
                link = $('<a>' + action['caption'] + '</a>').attr({'href': action['url']})
                if (action['ajax']) {
                    link.click(function(event) {
                        event.preventDefault();
                        link = $(this)
                        url = link.attr('href');
                        action_request = $.get(url)
                            .error(function(event) {
                                setTimeout('jobs_update();', 1000);
                                console.log(event);
                            });
                    });
                }
                link.button();
                actions_list.append(link);
            }
            valid_urls.push(action['url'])
        });
        actions_list.children().each(function() {
            if (valid_urls.indexOf($(this).attr('href')) == -1) {
                $(this).remove()
                console.log($(this))
            }
        });
    }

    job_markup = function(container, job) {
        container.children('.description').html(
            job['description'] + "<a href='/configure/job/" + job['id'] + "/'> [details]</a>"
        );

        container.children('.time').html(job['created_at']);
        if (job['cancel_url']) {
            if (container.children('.cancel').children().length == 0) {

                link = $("<a href='" + job['cancel_url'] + "'>[cancel]</a>")
                link.click(function(event){
                    event.preventDefault();
                    url = $(this).attr('href');
                    action_request = $.get(url)
                        .error(function(event) {
                            console.log(event);
                        });
                });

                container.children('.cancel').append(link);
            }
        } else {
            container.children('.cancel').html("");
        }

        if (job['state'] == 'pending') {
            container.children('.icon').attr('src', "{{STATIC_URL}}/images/icon_hourglass.png");
        } else if (job['state'] == 'tasked') {
            container.children('.icon').attr('src', "{{STATIC_URL}}/images/ajax-loader.gif");
        } else if (job['errored']) {
            container.children('.icon').attr('src', "{{STATIC_URL}}/images/dialog-error.png");
        } else if (job['cancelled']) {
            container.children('.icon').attr('src', "{{STATIC_URL}}/images/gtk-cancel.png");
        } else if (job['state'] == 'complete') {
            container.children('.icon').attr('src', "{{STATIC_URL}}/images/icon_tick.png");
        } else {
            console.log('no icon for job ' + job);
        }
    }

    load_json = function(data) {
        jobs = data['jobs']
        jobs.forEach(function(job) {
            id = "job_" + job['id'];
            if($('#' + id).length == 0) {
                $('#jobs').prepend(
                    $("<li class='ui-state-default'>" + 
                        "<img class='icon'/>" + 
                        "<span class='description'></span>" + 
                        "<span class='actions'></span>" + 
                        "<span class='cancel'></span>" + 
                        "<span class='time'></span>" + 
                        "</li>").attr({'id': id})
                )
            }
            job_markup($('#' + id), job);
        });
        
        stateful_objects = data['stateful_objects'];
        stateful_objects.forEach(function(stateful_object) {
            id = "stateful_object_" + stateful_object['content_type_id'] + "_" + stateful_object['id'];
            if($('#' + id).length == 0) {
            $('#stateful_objects').append($(
                    "<li class='ui-state-default'><span class='name'></span>  " + 
                    "<span class='state'></span>" +
                    "<span class='state_label'>State: </span>" + 
                    "<br><span class='actions'></span>" +
                    "</li>").attr({'id': id}))
            }
            stateful_object_markup($('#' + id), stateful_object);
        });
    }

    jobs_update = function() {
        jobs_request = $.get("{% url configure.views.jobs_json %}")
            .success(function(data, textStatus, jqXHR) {
                setTimeout('jobs_update();', 1000);
                load_json(data)
                
            })
            .error(function(event) {
                setTimeout('jobs_update();', 1000);
                console.log(event);
            });
    }

    initial_data = {{initial_data|safe}};

    $(document).ready(function() {
        load_json(initial_data); 
        setTimeout('jobs_update();', 1000);
    });
</script>

{% endblock %}

