%define name hydra-server
%define version @VERSION@
%define unmangled_version @VERSION@
%define release 1

Summary: The Whamcloud Lustre Monitoring and Adminisration Interface
Name: %{name}
Version: %{version}
Release: %{release}
Source0: %{name}-%{unmangled_version}.tar.gz
Source1: hydra-server.conf
Source2: hydra-worker-init.sh
License: Proprietary
Group: Development/Libraries
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-buildroot
Prefix: %{_prefix}
BuildArch: noarch
Vendor: Whamcloud, Inc. <info@whamcloud.com>
Url: http://www.whamcloud.com/
Requires: Django >= 1.3, mod_wsgi, httpd, rrdtool-python, lmt-server, python-dateutil, python-uuid, python-multiprocessing, python-paramiko, django-pagination, django-kombu, django-celery, rsyslog, mysql-python >= 1.2.1p2

%description
This is the Whamcloud Monitoring and Adminstration Interface

%prep
%setup -n %{name}-%{unmangled_version}

%build
python setup.py build

%install
make install DESTDIR=$RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT/etc/{init,httpd/conf}.d 
cp %{SOURCE1} $RPM_BUILD_ROOT/etc/httpd/conf.d/hydra-server.conf
cp %{SOURCE2} $RPM_BUILD_ROOT/etc/init.d/hydra-worker

%clean
rm -rf $RPM_BUILD_ROOT

%post
ed /etc/httpd/conf.d/wsgi.conf <<EOF 2>/dev/null
/^#LoadModule /s/^#\(LoadModule wsgi_module modules\/mod_wsgi.so\)/\1/
w
q
EOF

# start apache at boot time
chkconfig httpd on
# start cerebrod at boot time
chkconfig cerebrod on
# start rsyslog at boot time
chkconfig rsyslog on
# start hydra-work at boot time
chkconfig --add hydra-worker
# start mysqld at boot time
chkconfig mysqld on
if [ -f /var/lib/mysql/test ]; then
    # remove the test database and user from mysqld
    /usr/bin/mysql_secure_installation
fi
cd /usr/share/hydra-server
# create the hydra database
PYTHONPATH=$(pwd) python manage.py dbshell << EOF
create database hydra
EOF
# and populate it
PYTHONPATH=$(pwd) python manage.py syncdb --noinput

%files
%defattr(-,root,root)
%dir %attr(0755,apache,apache)/usr/share/hydra-server
/usr/share/hydra-server/*
/etc/httpd/conf.d/hydra-server.conf
%attr(0755,root,root)/etc/init.d/hydra-worker
