%define name hydra-server
%define version @VERSION@
%define unmangled_version @VERSION@
%define release 1

Summary: The Whamcloud Lustre Monitoring and Adminisration Interface
Name: %{name}
Version: %{version}
Release: %{release}
Source0: %{name}-%{unmangled_version}.tar.gz
Source1: hydra-server.conf
Source2: hydra-worker-init.sh
Source3: hydra-storage-init.sh
Source4: chroma-service-init.sh
License: Proprietary
Group: Development/Libraries
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-buildroot
Prefix: %{_prefix}
BuildArch: noarch
Vendor: Whamcloud, Inc. <info@whamcloud.com>
Url: http://www.whamcloud.com/
Requires: Django >= 1.3, mod_wsgi, httpd, python-dateutil, python-uuid, python-multiprocessing, python-paramiko, django-pagination, python-kombu >= 1.5.1, django-celery, rsyslog-mysql, mysql-server, MySQL-python >= 1.2.1p2, rabbitmq-server, django-picklefield, python-amqplib, django-piston, django-r3d, avahi-dnsconfd avahi-python, python-daemon, pygobject2 python-celery >= 2.4.5
Conflicts: hydra-agent

%description
This is the Whamcloud Monitoring and Adminstration Interface

%prep
%setup -n %{name}-%{unmangled_version}
echo -e "/^DEBUG =/s/= .*$/= False/\nwq" | ed settings.py 2>/dev/null

%build
python setup.py build

%install
make install DESTDIR=$RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT/etc/{init,httpd/conf}.d
cp %{SOURCE1} $RPM_BUILD_ROOT/etc/httpd/conf.d/hydra-server.conf
cp %{SOURCE2} $RPM_BUILD_ROOT/etc/init.d/hydra-worker
cp %{SOURCE3} $RPM_BUILD_ROOT/etc/init.d/hydra-storage
cp %{SOURCE4} $RPM_BUILD_ROOT/etc/init.d/chroma-service

%clean
rm -rf $RPM_BUILD_ROOT

%post
ed /etc/httpd/conf.d/wsgi.conf <<EOF 2>/dev/null
/^#LoadModule /s/^#\(LoadModule wsgi_module modules\/mod_wsgi.so\)/\1/
w
q
EOF
# make sure apache sees our changes
service httpd reload

# Pre-create log files to set permissions
mkdir -p /var/log/hydra
touch /var/log/hydra/job.log
touch /var/log/hydra/audit.log
touch /var/log/hydra/storage_plugin.log
touch /var/log/hydra/api.log
touch /var/log/hydra/metrics.log
chown -R apache:apache /var/log/hydra

# This is required for opening connections between
# httpd and rabbitmq-server
setsebool -P httpd_can_network_connect 1 2>/dev/null


# RabbitMQ: Configure default hydra user if it's not already set up
rabbitmqctl list_users | grep "^hydra\\s" > /dev/null || rabbitmqctl add_user hydra hydra123
rabbitmqctl list_vhosts | grep "^hydravhost$" > /dev/null || rabbitmqctl add_vhost hydravhost
rabbitmqctl set_permissions -p hydravhost hydra ".*" ".*" ".*"
service rabbitmq-server restart

# Configure default (local) mysql service
# Depending on what the user selects during
# configuration, this may or may not be used,
# but it is needed for the bootstrap process
chkconfig mysqld on
service mysqld restart
DATABASE_NAME="chroma"
if [ ! -d /var/lib/mysql/${DATABASE_NAME} ]; then
    # TODO: invoke /usr/bin/mysql_server_installation or
    # something similar (leaving a local-only MySQL instance
    # with a default password known to chroma)
    echo "create database ${DATABASE_NAME}" | mysql
fi

# Set rsyslog to start on boot (it won't do anything
# until chroma sets up and restarts it though)
chkconfig rsyslog on

# Before starting apache, build the /static directory
# Requires MySQL to be up (Django ticket #17656)
PYTHONPATH=/usr/share/hydra-server python /usr/share/hydra-server/manage.py collectstatic --noinput

# Start apache which present the UI
# for the bootstrap process
chkconfig httpd on
service httpd restart

# Start the chroma-service daemon which
# is used to bootstrap the other services
chkconfig --add chroma-service
service chroma-service restart



%preun
service chroma-service stop
service hydra-worker stop
service hydra-storage stop
# remove the /static/ dir of files that was created by Django's collectstatic
rm -rf /usr/share/hydra-server/static

%postun
# remove rsyslog entries if this the last version being removed.
if [[ $1 -eq 0 ]]; then
    # configure rsyslog.conf
    while egrep -q  "^# Added by hydra-server" /etc/rsyslog.conf; do
        ed /etc/rsyslog.conf <<"EOF" 2>/dev/null
/^# Added by hydra-server/;/^# Added by hydra-server/d
w
q
EOF
    done
fi

%files
%defattr(-,root,root)
%{_bindir}/hydra-host-discover.py*
%dir %attr(0755,apache,apache)/usr/share/hydra-server
/usr/share/hydra-server/*
/etc/httpd/conf.d/hydra-server.conf
%attr(0755,root,root)/etc/init.d/hydra-worker
%attr(0755,root,root)/etc/init.d/hydra-storage
%attr(0755,root,root)/etc/init.d/chroma-service
