# From: https://gist.github.com/vitkin/6661683/raw/0b784736271e8e078fffc10e2eb483e91feb6a8a/README.md

# Backport WebSocket to Apache 2.2

This is my variation from the
[original patch](http://cafarelli.fr/gentoo/apache-2.2.24-wstunnel.patch)
and that also includes the suggested correction for the
[bug with secure websocket 'wss://'](https://issues.apache.org/bugzilla/show_bug.cgi?id=55320).

The difference is that I avoid modifying the **mod_utils.c** and the
**mod_proxy.h** so that if the **mod_proxy** module has been embedded in the
main **httpd** binary then it will work and you won't get the
`error: undefined symbol: ap_proxy_pass_brigade`.

Indeed you can check that the module **mod_proxy** is part of _Apache_ main
binary by running the command:
```bash
httpd -l | grep mod_proxy
```

## Instructions:

 1. Checkout apache source (Replace 'x' with the right number.):
    ```bash
    svn checkout \
        http://svn.apache.org/repos/asf/httpd/httpd/tags/2.2.x/ \
        httpd-2.2.x
    ```

 2. Get the patch and apply it
    ```bash
    wget https://gist.github.com/vitkin/6661683/raw/873dd8b4de4ad1ff69757ffe48fc574374aedc57/apache-2.2-wstunnel.patch
    cd httpd-2.2.x
    patch -p1 -i ../apache-2.2-wstunnel.patch
    ```

 3. Build _Apache_:
    ```bash
    autoconf
    ./configure --enable-so --enable-proxy --enable-proxy_wstunnel=shared
    make
    ```

 4. Just copy the resulting file **modules/proxy/.libs/mod_proxy_wstunnel.so** to your Apache modules folder and follow the instructions from any of the hereunder references.

> **Notes:**
>
> - Don't forget to check that the configuration is OK by running the command:
>   ```bash
>   apachectl configtest
>   ```
>
> - You may encounter some compilation error with version 2.2.22 and later similar to:
>   ```bash
>   modules/http/.libs/libmod_http.a(byterange_filter.o): In function `ap_set_byterange':
>   byterange_filter.c:(.text+0x130d): undefined reference to `apr_array_clear'
>   collect2: ld returned 1 exit status
>   ```
>   This is a [known bug](https://issues.apache.org/bugzilla/show_bug.cgi?id=53162).
>   A workaround consist in adding `--with-included-apr` to the configure options:
>   ```bash
>   ./configure --enable-so --enable-proxy --enable-proxy-wstunnel=shared --with-included-apr
>   ```

## References:

* [_Apache 2.2 Websocket_ Proxying on Ubuntu with **mod_proxy_wstunnel**](http://www.amoss.me.uk/2013/06/apache-2-2-websocket-proxying-ubuntu-mod_proxy_wstunnel/)

* [Backporting _Apache_ support for _websockets_ reverse proxy](http://blog.cafarelli.fr/post/2013/04/26/Backporting-Apache-support-for-websockets-reverse-proxy-%28aka-getting-GateOne-to-work-behind-Apache%29)

* [How to use _Voyageur's Apache websocket_ backport with _pump.io_](https://i.rationa.li/mark/note/co97okgZSC-bIvONa5ai6Q)
