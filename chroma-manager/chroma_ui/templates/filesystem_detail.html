<script language="javascript">
  var FilesystemDetailView = function() {
    var initialized = false;
    var conf_param_dialog;
    var volume_chooser_store;
    var filesystem;

    function draw(id) {
      if (!initialized) {
        init();
        initialized = true;
      }

      $('#ost').dataTable().fnClearTable();
      $('#mdt').dataTable().fnClearTable();
      $('#mgt_configuration_view').dataTable().fnClearTable();

      conf_param_dialog = undefined;
      loadFilesystem(id);
    }

    function create_osts(osts)
    {
      var i;
      function chain_creation(i) {
          if (i == undefined) {
              i = 0;
          }

          Api.post("target/", osts[i],
                  function(data)
                  {
                      if (i == osts.length - 1) {
                          // Last POST succeeded, reload table
                          $('#ost').dataTable().fnClearTable();
                          $('#mdt').dataTable().fnClearTable();
                          $('#mgt_configuration_view').dataTable().fnClearTable();
                          volume_chooser_store.reload();
                          loadFilesystem(filesystem.id);
                      } else {
                          // POST the next OST creation
                          chain_creation(i + 1);
                      }
                  });
      }

      chain_creation();
    }

    function init()
    {
      $('div#filesystem_detail button.advanced').click(function() {
        conf_param_dialog.open();
      });

      $('div#filesystem_detail button.mount_info').click(function() {
          var markup = _.template($('#filesystem_mount_info_template').html())({filesystem: filesystem});
          $(markup).dialog({
              width: 800,
              buttons: {
                  "Close": {
                      click: function() {$(this).dialog('close')},
                      text: 'Close',
                      class: 'close'
                  }}
          });
      });

      // Create new OST button click handler.
      volume_chooser_store = VolumeChooserStore();
      volume_chooser_store.load(function() {
        $('#new_ost_chooser').volumeChooser({
            multi_select: true,
            store: volume_chooser_store,
            change: function() {
                var val = $(this).volumeChooser('val');
                $('#ost_ok_button').button('option', 'disabled', val.length == 0);
            }
        });
      });
      $('#btnNewOST').click(function() {
        $('#new_ost_dialog').dialog('open');
        $('#new_ost_dialog').find('table').width("100%");
        volume_chooser_store.reload(); // HYD-1309 reload available targets on display
        $('#new_ost_chooser').volumeChooser('clear');
        $('#ost_ok_button').button('option', 'disabled', true)
      });

      $('#new_ost_dialog').dialog({
        autoOpen: false,
        width: 1100,
        maxHeight:470,
        position:"center",
        show: "clip",
        modal: true,
        buttons:
        {
          "Ok":
          {
            text: "Create",
            id: "ost_ok_button",

            click: function(){
              // HYD-987 - Prevent multiple submissions
              // just close the dialog right away and let the OST run
              $(this).dialog("close");

              function create_osts(osts) {
                Api.patch("target/", {objects: osts, deletions: []},
                  function(data) {
                    // Reload view
                    $('#ost').dataTable().fnClearTable();
                    $('#mdt').dataTable().fnClearTable();
                    $('#mgt_configuration_view').dataTable().fnClearTable();
                    volume_chooser_store.reload();
                    loadFilesystem(filesystem.id);
                });
              }

              var osts = _.map($('#new_ost_chooser').volumeChooser('val'), function(volume_id) {
                return {kind: 'OST', filesystem_id: filesystem.id, volume_id: volume_id}
              });

              // Before submitting new OSTs, conditionally prompt for reformat
              volume_chooser_store.reformatPrompt(
                  $('#new_ost_chooser').volumeChooser('val'),
                  function() {
                      create_osts(osts);
                  },
                  function() {
                      osts = _.map(osts, function(ost) {ost.reformat = true ; return ost;});
                      create_osts(osts);
                  }
              )
            }
          },
          "Cancel": function() {
            $(this).dialog("close");
          }
        }
      });

      var generateCommandDropdown = angular.element('html').injector().get('generateCommandDropdown');
      function transformFunc (data) { return data[5]; }

      /* Tables of targets */
      var target_table_elements = ['#mgt_configuration_view', '#ost', '#mdt'];
      $.each(target_table_elements, function(i, selector) {
        $(selector).dataTable( {
          bInfo: false,
          "bProcessing": true,
          "bJQueryUI": true,
          "bFilter": false,
          "bPaginate": false,
          "aoColumns": [
            { "sClass": 'txtleft' },
            { "sClass": 'txtleft' },
            { "sClass": 'txtleft' },
            { "sClass": 'txtleft' },
            { "sClass": 'txtleft' },
            { "sClass": 'txtcenter actions-cell', bSortable: false},
            { "sClass": 'txtcenter', bSortable: false}
          ],
          fnRowCallback: generateCommandDropdown.dataTableCallback(6, transformFunc, _.isEmpty)
        });
      });
    }

    function loadFilesystem(id) {
      Api.get("filesystem/" + id + "/", {},
      success_callback = function(filesystem_data)
      {
        filesystem = filesystem_data;
        /* FS summary fields */
        $('#bytes_used').html(formatBytes(filesystem.bytes_total - filesystem.bytes_free));
        $('#bytes_total').html(formatBytes(filesystem.bytes_total));
        $('#inodes_used').html(formatBigNumber(filesystem.files_total - filesystem.files_free));
        $('#inodes_total').html(formatBigNumber(filesystem.files_total));
        $('#ost_count').html(filesystem.osts.length);
        $('#mgs_name').html(RouteUtils.uri_properties_link(filesystem.mgt.primary_server, filesystem.mgt.primary_server_name));
        $('#mds_name').html(RouteUtils.uri_properties_link(filesystem.mdts[0].primary_server, filesystem.mdts[0].primary_server_name));
        $('#fs_alerts').html(LiveObject.alertLabel(filesystem));
        $('#fs_name').html(filesystem.name);

        var generateCommandDropdown = angular.element('html').injector().get('generateCommandDropdown');
        var $commandDropdown = generateCommandDropdown.generateDropdown(angular.element('#fs_actions'), filesystem, 'right');

        $commandDropdown.after(LiveObject.busyIcon(filesystem));

        // Config param dialog
        conf_param_dialog = ConfParamDialog({object: filesystem, conf_params: filesystem.conf_params});

        // Monitored filesystems can't have new targets
        $('#btnNewOST').button('option', 'disabled', filesystem.immutable_state);
        // Monitored filesystems can't edit conf params
        $('div#filesystem_detail button.advanced').button('option', 'disabled', filesystem.immutable_state);

        // Free space pie charts
        LoadFSGraph_EditFS(filesystem);
      });

      loadFilesystemTargets(id);
    }

    function loadFilesystemTargets(id)
    {
      Api.get("target/", {filesystem_id : id, limit: 0},
      success_callback = function(data)
      {
        var targets = data.objects;
        $.each(targets, function(i, target)
        {
          var tooltip = "";
          $.each(target.volume.volume_nodes, function(i, node) {
            tooltip = tooltip + node.host_label + ":" + node.path + "\n";
          });
          var volume_markup = "<span title='" + $.trim(tooltip) + "'>" + target.volume.label + "</span>"
          var row = [
                  RouteUtils.object_properties_link(target),
                  volume_markup,
                  RouteUtils.uri_properties_link(target.primary_server, target.primary_server_name),
                  RouteUtils.uri_properties_link(target.failover_servers[0], target.failover_server_name),
                  LiveObject.active_host(target),
                  target,
                  LiveObject.icons(target)
                ];
          if (target.kind == "OST") {
            $('#ost').dataTable().fnAddData(row);
          } else if (target.kind == "MGT") {
            $('#mgt_configuration_view').dataTable().fnAddData(row);
          } else if (target.kind == "MDT") {
            $('#mdt').dataTable().fnAddData(row);
          }
        });
      });
    }

    return {
      draw:draw
    }
  }();
</script>

<script language="text/template" id='filesystem_mount_info_template'>
    <div class='filesystem_mount_info'>
        <h1><%= filesystem.name %> mount information</h1>
        <p>To mount this filesystem on a Lustre client, use the following command:</p>
        <pre><%= filesystem.mount_command %></pre>
    </div>
</script>

<div id='filesystem_detail' class='detail_screen'>
<h1 class="page-header"><i class="icon-sitemap"></i> File System <span id='fs_name'></span></h1>

<h2 class='section_header' id='edit_fs_title'>Overview</h2>
<div style='float:left;'>
  <table class='fs'>
    <tr>
      <th>Management Server:</th><td id='mgs_name'></td>
    </tr>
    <tr>
      <th>Metadata Server:</th><td id='mds_name'></td>
    </tr>
    <tr>
      <th>OSTs:</th><td id='ost_count'></td>
    </tr>
    <tr>
      <th>Alerts:</th><td id='fs_alerts'></td>
    </tr>
    <tr>
      <th>Actions:</th><td id='fs_actions'></td>
    </tr>
  </table>
  <p>
    <button class='advanced' type="button">Advanced Settings</button>
    <button class='mount_info' type="button">Client mount information</button>
  </p>
</div>

<div style='float:left; margin-left: 12px;'>
  <div id="editfs_space_usage"></div>
  <p align=center><span id="bytes_used"></span>/<span id="bytes_total"></span></p>
</div>
<div style='float:left; margin-left: 12px;'>
  <div id="editfs_inode_usage"></div>
  <p align=center><span id="inodes_used"></span>/<span id="inodes_total"></span>&nbsp;inodes</p>
</div>

<div style='clear:both;'></div>

<h2 class='section_header'>Management Target</h2>
<table cellpadding="0" cellspacing="0" border="0" class="display" id="mgt_configuration_view" width="100%">
  <thead>
    <tr>
      <th width="12%">Name</th>
      <th width="15%"><a data-topic="_volume_short" class='help_hover'>Volume</a></th>
      <th width="7%">Primary&nbsp;server</th>
      <th width="7%">Failover&nbsp;server</th>
      <th width="12%">Started&nbsp;on</th>
      <th width='1%'></th>
      <th width='1%'></th>
    </tr>
  </thead>
  <tbody id="example_content">
    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  </tbody>
</table>

<h2 class='section_header'>Metadata Target</h2>
<table cellpadding="0" cellspacing="0" border="0" class="display" id="mdt" width="100%">
  <thead>
    <tr>
      <th width="12%">Name</th>
      <th width="15%"><a data-topic="_volume_short" class='help_hover'>Volume</a></th>
      <th width="7%">Primary&nbsp;server</th>
      <th width="7%">Failover&nbsp;server</th>
      <th width="12%">Started&nbsp;on</th>
      <th width='1%'></th>
      <th width='1%'></th>
    </tr>
  </thead>
  <tbody id="mdt_content">
    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  </tbody>
</table>

<h2 class="section_header">Object Storage Targets</h2>
<p><button class='add' type="button" id="btnNewOST">Create new OST</button></p>
<table cellpadding="0" cellspacing="0" border="0" class="display" id="ost" width="100%">
  <thead>
    <tr>
      <th width="12%">Name</th>
      <th width="15%"><a data-topic="_volume_short" class='help_hover'>Volume</a></th>
      <th width="7%">Primary&nbsp;server</th>
      <th width="7%">Failover&nbsp;server</th>
      <th width="12%">Started&nbsp;on</th>
      <th width='1%'></th>
      <th width='1%'></th>
    </tr>
  </thead>
  <tbody id="ost_content">
    <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
  </tbody>
</table>

<p></p>
<p align='left'>
  <a class='navigation button' href="configure/filesystem/list/">Back to file systems</a>
</p>

<!-- new OST popup showing all usable luns-->
<div id="new_ost_dialog" title="Create OST">
  <button id='new_ost_chooser'></button>
</div>
</div>
