#!/bin/bash
set -x

[ -r localenv ] && . localenv

CHROMA_DIR=${CHROMA_DIR:-"$PWD/chroma/"}
CLUSTER_CONFIG=${CLUSTER_CONFIG:-"$CHROMA_DIR/chroma-manager/tests/framework/gui/selenium_cluster_config.json"}

eval $(python $CHROMA_DIR/chroma-manager/tests/utils/json_cfg2sh.py "$CLUSTER_CONFIG")

trap "set +e; scp -r chromatest@$TEST_RUNNER:test_reports $WORKSPACE" EXIT

ssh chromatest@$TEST_RUNNER <<EOC
set -ex
mkdir test_reports
vncserver :1 -geometry 1024x768
export DISPLAY=\$(hostname):1
export NODE_PATH=/usr/lib/node_modules
export RUNNER=CI

INTEL_JS_MODULES=${INTEL_JS_MODULES:-"/home/chromatest/chroma_test_env/chroma/chroma-manager/ui-modules/node_modules/@intel-js"}

#######################################
# New UI Tests
#######################################

# Run angular-modules
cd \$INTEL_JS_MODULES/angular-modules
./node_modules/karma/bin/karma start --browsers Chrome,Firefox --singleRun true --reporters dots,junit
mv test-results.xml \$HOME/test_reports/karma-test-results-angular-modules.xml

# Run Karma GUI unit tests (new ui)
cd \$INTEL_JS_MODULES/gui
./node_modules/karma/bin/karma start --browsers Chrome,Firefox --singleRun true --reporters dots,junit
mv test-results/*.xml \$HOME/test_reports/
rm -rf ./test-results

# Run gulp Test(s)
cd \$INTEL_JS_MODULES/gui/gulp
\$INTEL_JS_MODULES/ziplocker/node_modules/npm/bin/npm-cli.js t
mv gulp-results.xml \$HOME/test_reports/

MODULES_TO_TEST="dirp
extract-api
fp
gulp-iife-wrap
iife-wrap
karma-iife-wrap-preprocessor
natural-sort
obj
realtime
req
router
socket-worker
srcmap-reverse
stub-daddy
through
view-server
ziplocker"

for module_name in \$MODULES_TO_TEST
do
    # Run test
    cd \$INTEL_JS_MODULES/\$module_name
    \$INTEL_JS_MODULES/ziplocker/node_modules/npm/bin/npm-cli.js t
    mv \$module_name-results.xml \$HOME/test_reports/\$module_name-results.xml
done


#######################################
# Old UI Tests
#######################################

# Run Karma GUI unit tests (old ui)
cd \$HOME/chroma_test_env/chroma/chroma-manager/chroma_ui
./node_modules/karma/bin/karma start --browsers Chrome,Firefox --singleRun true --reporters dots,junit
mv test-results.xml \$HOME/test_reports/karma-test-results-old-ui.xml

EOC

NUM_EXPECTED_TEST_REPORTS=22
NUM_TEST_REPORTS=$(ssh chromatest@$TEST_RUNNER 'ls -l test_reports' | grep -v "^total " | wc -l)
if [ $NUM_TEST_REPORTS -ne $NUM_EXPECTED_TEST_REPORTS ]; then
    echo "Incorrect number of test reports. Possible sources include a catastrophic error running one of the test suites, or adding a new test set that causes there to be an new xml file. Expected $NUM_EXPECTED_TEST_REPORTS, but found $NUM_TEST_REPORTS."
    exit 1
else
    exit 0
fi
