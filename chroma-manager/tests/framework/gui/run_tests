#!/bin/bash
set -x

[ -r localenv ] && . localenv

CHROMA_DIR=${CHROMA_DIR:-"$PWD/chroma/"}
CLUSTER_CONFIG=${CLUSTER_CONFIG:-"$CHROMA_DIR/chroma-manager/tests/framework/gui/selenium_cluster_config.json"}

eval $(python $CHROMA_DIR/chroma-manager/tests/utils/json_cfg2sh.py "$CLUSTER_CONFIG")

trap "set +e; scp -r chromatest@$TEST_RUNNER:test_reports $WORKSPACE" EXIT

ssh chromatest@$TEST_RUNNER <<EOC
set -ex
mkdir test_reports
vncserver :1 -geometry 1024x768
export DISPLAY=\$(hostname):1
export RUNNER=CI
export NPM_CONFIG_PREFIX=~/.npm-global
export PATH=~/.npm-global/bin:$PATH

NODE_MODULES=${NODE_MODULES:-"/home/chromatest/chroma_test_env/chroma/chroma-manager/ui-modules/node_modules"}

#######################################
# New UI Tests
#######################################

# Run Karma GUI unit tests (new ui)
cd \$NODE_MODULES/intel-gui
./node_modules/karma/bin/karma start --browsers Chrome,Firefox --singleRun true --reporters dots,junit
mv test-results/*.xml \$HOME/test_reports/
rm -rf ./test-results

# Run gulp Test(s)
cd \$NODE_MODULES/intel-gui/gulp
npm t
mv gulp-results.xml \$HOME/test_reports/

MODULES_TO_TEST="intel-realtime
intel-view-server"

for module_name in \$MODULES_TO_TEST
do
    # Run test
    cd \$NODE_MODULES/\$module_name
    npm t
    mv *-results-*.xml \$HOME/test_reports/test-\$module_name-results.xml
done


#######################################
# Old UI Tests
#######################################

# Run Karma GUI unit tests (old ui)
cd \$HOME/chroma_test_env/chroma/chroma-manager/chroma_ui
\$NODE_MODULES/intel-gui/node_modules/karma/bin/karma start --browsers Chrome,Firefox --singleRun true --reporters dots,junit
for filename in TESTS-*.xml; do mv "\$filename" "\$HOME/test_reports/OLD_\$filename"; done;

EOC

NUM_EXPECTED_TEST_REPORTS=7
NUM_TEST_REPORTS=$(ssh chromatest@$TEST_RUNNER 'ls -l test_reports' | grep -v "^total " | wc -l)
if [ $NUM_TEST_REPORTS -ne $NUM_EXPECTED_TEST_REPORTS ]; then
    echo "Incorrect number of test reports. Possible sources include a catastrophic error running one of the test suites, or adding a new test set that causes there to be an new xml file. Expected $NUM_EXPECTED_TEST_REPORTS, but found $NUM_TEST_REPORTS."
    exit 1
else
    exit 0
fi
